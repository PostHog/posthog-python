#!/usr/bin/env bash
#/ Usage: bin/run_integration_tests [--debug]
#/ Description: Runs integration tests for PostHog Python SDK
#/ Options:
#/   --debug    Enable debug mode for verbose output
source bin/helpers/_utils.sh
set_source_and_root_dir

ensure_virtual_env

# Parse arguments
DEBUG_MODE=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --debug)
            DEBUG_MODE=true
            shift
            ;;
        --help|-h)
            grep '^#/' "$0" | cut -c4-
            exit 0
            ;;
        *)
            error "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

echo "ğŸš€ PostHog Python SDK Integration Tests"
echo "=" | head -c 40 | tr '\n' '='
echo

# Load .env file if it exists
if [ -f ".env" ]; then
    echo "ğŸ“ Loading environment variables from .env file..."
    set -a  # automatically export all variables
    source .env
    set +a  # disable auto-export
fi

# Check if the integration test file exists
INTEGRATION_TEST_FILE="posthog/test/manual_integration/test_flag_dependencies.py"
if [ ! -f "$INTEGRATION_TEST_FILE" ]; then
    fatal "âŒ Integration test file not found: $INTEGRATION_TEST_FILE"
fi

echo "ğŸ“‹ Running flag dependencies integration test..."
if [ "$DEBUG_MODE" = true ]; then
    echo "ğŸ” Debug mode enabled"
    export POSTHOG_DEBUG=true
fi
echo

# Run the integration test
if python "$INTEGRATION_TEST_FILE"; then
    echo
    echo "ğŸ‰ All integration tests passed!"
    exit 0
else
    echo
    error "ğŸ’¥ Integration tests failed!"
    exit 1
fi